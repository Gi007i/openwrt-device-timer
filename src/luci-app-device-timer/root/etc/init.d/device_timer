#!/bin/sh /etc/rc.common
# device_timer init script - procd managed daemon

START=95
STOP=10

USE_PROCD=1

PROG=/usr/sbin/device_timer_daemon.sh
CONF=device_timer

start_service() {
	local enabled
	config_load "$CONF"
	config_get enabled settings enabled "0"

	[ "$enabled" != "1" ] && return 0

	# Validate configuration before starting
	if [ -x "/usr/sbin/device_timer_validate" ]; then
		if ! /usr/sbin/device_timer_validate; then
			logger -t device_timer "Service not started due to config errors"
			return 1
		fi
	fi

	mkdir -p /tmp/device_timer

	procd_open_instance
	procd_set_param command "$PROG"
	procd_set_param respawn 3600 5 5
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param pidfile /var/run/device_timer.pid
	procd_close_instance
}

stop_service() {
	# Daemon handles cleanup via SIGTERM trap
	:
}

reload_service() {
	# Validate configuration before reload
	if [ -x "/usr/sbin/device_timer_validate" ]; then
		if ! /usr/sbin/device_timer_validate; then
			logger -t device_timer "Reload aborted due to config errors"
			return 1
		fi
	fi
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "$CONF"
}
